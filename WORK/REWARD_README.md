# Система обработки наград (Reward System)

## Описание

Система обработки наград предназначена для выгрузки профилей участников по кодам наград из API геймификации Сбербанка.

## Возможности

### Основные функции
- ✅ Генерация JavaScript скриптов для выгрузки данных
- ✅ Поддержка двух окружений: SIGMA (продакшн) и ALPHA (тестовое)
- ✅ Автоматическое извлечение профилей из различных структур данных
- ✅ Конвертация JSON в Excel с детальной статистикой
- ✅ Обработка ошибок и повторные попытки
- ✅ Настраиваемые таймауты и задержки

### Структуры данных
Система поддерживает следующие структуры ответов API:
1. `body.badge.profiles` - профили в структуре badge
2. `body.profiles` - прямые профили в body
3. `body.array` - массив профилей в body
4. `root.array` - массив профилей в корне

## Конфигурация

### Параметры вариантов
```json
{
  "timeout": 30000,           // Таймаут запроса в миллисекундах
  "retry_count": 3,           // Количество попыток при ошибке
  "delay_between_requests": 10 // Задержка между запросами в миллисекундах
}
```

### Опции обработки
```json
{
  "include_photo_data": false,        // Включать ли данные фотографий
  "include_division_ratings": true,   // Включать ли рейтинги подразделений
  "include_badge_info": true,         // Включать ли информацию о наградах
  "max_profiles_per_request": 1000,   // Максимальное количество профилей на запрос
  "skip_empty_profiles": true         // Пропускать ли пустые профили
}
```

## Использование

### 1. Подготовка данных
Создайте CSV файл с кодами наград в формате:
```csv
REWARD_CODE
REWARD_001
REWARD_002
REWARD_003
```

### 2. Генерация скрипта
```python
# Генерация скрипта для SIGMA
generate_reward_script()

# Генерация скрипта для ALPHA
# Измените selected_variant на "alpha" в конфигурации
```

### 3. Выполнение скрипта
1. Откройте DevTools в браузере
2. Вставьте сгенерированный скрипт в консоль
3. Нажмите Enter для выполнения
4. Дождитесь скачивания JSON файла

### 4. Конвертация в Excel
```python
# Конвертация JSON в Excel
convert_specific_json_file("profiles_SIGMA_20250101-120000", "reward")
```

## Выходные данные

### JSON структура
```json
{
  "REWARD_001": {
    "data": { /* исходные данные API */ },
    "structure": "body.badge.profiles",
    "profilesCount": 5,
    "badgeInfo": {
      "name": "Награда за достижения",
      "description": "Описание награды",
      "type": "achievement",
      "category": "sales"
    }
  }
}
```

### Excel структура
- **DATA** - основные данные профилей
- **SUMMARY** - общая сводка
- **STATISTICS** - статистика по подразделениям
- **REWARD_SUMMARY** - сводка по наградам (только для reward)

### Поля профиля
- `rewardCode` - код награды
- `badgeName` - название награды
- `badgeDescription` - описание награды
- `badgeType` - тип награды
- `badgeCategory` - категория награды
- `employeeNumber` - табельный номер
- `lastName`, `firstName`, `middleName` - ФИО
- `fullName` - полное имя
- `email`, `phone`, `mobilePhone` - контакты
- `terDivisionName`, `divisionName`, `departmentName` - подразделения
- `positionName` - должность
- `employeeStatus` - статус сотрудника
- `businessBlock` - бизнес-блок
- `awardDate`, `awardReason`, `awardLevel`, `awardValue` - информация о награде
- `indicatorValue`, `successValue`, `rating`, `placeInRating` - показатели
- `photoUrl`, `isActive`, `lastActivityDate` - дополнительные данные

## Обработка ошибок

### Типы ошибок
- **HTTP ошибки** - статус коды 4xx, 5xx
- **Таймауты** - превышение времени ожидания
- **Ошибки сети** - проблемы с соединением
- **Ошибки парсинга** - неверная структура данных

### Стратегия повторных попыток
- Автоматические повторные попытки при ошибках
- Экспоненциальная задержка между попытками
- Логирование всех ошибок с деталями

## Мониторинг

### Логирование
- Подробные логи всех операций
- Статистика обработки
- Информация об ошибках

### Статистика выполнения
- Общее количество кодов наград
- Количество успешно обработанных
- Количество пропущенных
- Количество ошибок
- Общее количество профилей

## Примеры использования

### Базовый пример
```python
# Генерация скрипта
script = generate_reward_script()

# Конвертация результатов
convert_reward_json_to_excel("profiles_SIGMA_20250101-120000.json", "reward_data.xlsx", "reward")
```

### Настройка параметров
```python
# Изменение конфигурации
FUNCTION_CONFIGS["reward"]["selected_variant"] = "alpha"
FUNCTION_CONFIGS["reward"]["variants"]["alpha"]["timeout"] = 60000
FUNCTION_CONFIGS["reward"]["variants"]["alpha"]["retry_count"] = 5
```

## Требования

### Системные требования
- Python 3.8+
- pandas
- openpyxl
- requests

### Доступ к API
- Авторизация в системе геймификации
- Доступ к соответствующим API endpoints
- Сетевой доступ к серверам Сбербанка

## Поддержка

### Известные ограничения
- Максимальное количество профилей на запрос: 1000
- Таймаут по умолчанию: 30 секунд
- Задержка между запросами: 10 миллисекунд

### Рекомендации
- Используйте тестовое окружение ALPHA для разработки
- Мониторьте логи для выявления проблем
- Регулярно обновляйте коды наград в CSV файле
- Проверяйте права доступа к API endpoints 