# Генератор JavaScript Скриптов для Геймификации

Программа для генерации JavaScript скриптов, которые используются в браузере для извлечения данных из различных сервисов геймификации.

## Структура проекта

```
Generate_LoadDB_Script_Gamification/
├── main.py                          # Основная программа генерации скриптов
├── README.md                        # Документация
├── requirements.txt                 # Python зависимости
├── environment.yml                  # Conda окружение
├── setup_environment.sh             # Скрипт настройки окружения
├── .gitignore                       # Git настройки исключений
├── json_to_excel_base.py            # Базовый класс для JSON парсеров
├── json_parser_leaders_for_admin.py # Парсер JSON для LeadersForAdmin
├── json_parser_reward.py            # Парсер JSON для Reward
├── json_parser_profile.py           # Парсер JSON для Profile
├── json_parsers_runner.py           # Универсальный запускатель парсеров
├── /LOGS/                          # Каталог для файлов логов
├── /INPUT/                         # Каталог для входных данных
└── /OUTPUT/                        # Каталог для создаваемых файлов
```

## Начальные настройки и константы

### Настройки логирования

- **LOG_LEVEL**: Уровень логирования (`"INFO"` или `"DEBUG"`)
  - `INFO`: Базовые сообщения о старте, остановке и общей сводке
  - `DEBUG`: Подробная информация о выполнении каждой функции

- **LOG_DIR**: Путь до каталога логов (сырая строка)
  ```python
  LOG_DIR = r"/Users/orionflash/Desktop/MyProject/Gen_Load_Game_Script/LOGS"
  ```

- **LOG_FILENAME_BASE**: Базовое имя файла лога без расширения
  ```python
  LOG_FILENAME_BASE = "game_script_generator"
  ```

### Формат имени файла лога

Файл лога создается по шаблону:
```
{LOG_FILENAME_BASE}_{LOG_LEVEL}_{YYYY-MM-DD}.log
```

Пример: `game_script_generator_DEBUG_2024-01-15.log`

### Настройки каталогов

- **INPUT_DIR**: Каталог входных данных
  ```python
  INPUT_DIR = r"/Users/orionflash/Desktop/MyProject/Gen_Load_Game_Script/INPUT"
  ```

- **OUTPUT_DIR**: Каталог создаваемых файлов
  ```python
  OUTPUT_DIR = r"/Users/orionflash/Desktop/MyProject/Gen_Load_Game_Script/OUTPUT"
  ```

### Настройки обработки данных

- **DATA_SOURCE**: Источник данных (`"file"` или `"variable"`)
- **INPUT_FORMAT**: Формат входного файла (`"TXT"` или `"CSV"`)
- **INPUT_FILENAME**: Имя входного файла
- **INPUT_FILE_EXTENSION**: Расширение входного файла

### Настройки для TXT файлов

- **TXT_DELIMITERS**: Массив разделителей для TXT файлов
- Поддерживаемые разделители: `,`, `;`, `\t`, ` `, `\n`, `\r\n`, `|`, `:`, `.`, `!`, `?`, `@`, `#`, `$`, `%`, `^`, `&`, `*`, `(`, `)`, `[`, `]`, `{`, `}`, `<`, `>`, `/`, `\\`, `=`, `+`, `~`, `` ` ``, `'`, `"`
- Программа автоматически обрабатывает все разделители из массива, кроме "_" и "-"

### Настройки для CSV файлов

- **CSV_DELIMITER**: Разделитель колонок в CSV (по умолчанию `;`)
- **CSV_ENCODING**: Кодировка CSV файла (`"utf-8"`)
- **CSV_COLUMN_NAME**: Название столбца для извлечения данных

### Тексты для логирования

- **LOG_MESSAGES**: Словарь с шаблонами сообщений для логирования
- Все тексты используют форматирование с переменными: `{time}`, `{file_path}`, `{error}` и т.д.
- Примеры:
  ```python
  "start": "=== Старт работы программы: {time} ===",
  "reading_file": "Загрузка файла: {file_path}",
  "read_ok": "Файл успешно загружен: {file_path}, строк: {rows}",
  "func_start": "[START] {func} {params}",
  "func_end": "[END] {func} (время: {time:.3f}s)"
  ```

### Выбор активных скриптов

- **ACTIVE_SCRIPTS**: Список активных скриптов для генерации
- Программа автоматически генерирует только скрипты из этого списка
- Пример:
  ```python
  ACTIVE_SCRIPTS = [
      "leaders_for_admin",
      "reward", 
      "profile"
  ]
  ```

### Конфигурация функций

- **FUNCTION_CONFIGS**: Словарь с индивидуальными настройками для каждой функции
- Каждая функция имеет свои параметры: домен, API endpoints, источник данных, формат файлов

## Система логирования

### Особенности логирования

1. **Двухуровневое логирование**: INFO и DEBUG
2. **Временные метки**: До миллисекунд включительно
3. **Автоматическое создание файлов**: Если файл не существует - создается, если существует - дописывается
4. **Измерение времени выполнения**: Каждой функции и программы в целом

### Структура лог-сообщений

```
YYYY-MM-DD HH:MM:SS.mmm - GameScriptGenerator - LEVEL - MESSAGE
```

### Стартовое сообщение

```
======================================================================
СТАРТ ПРОГРАММЫ - Генератор JavaScript скриптов
Время начала обработки: 2024-01-15 14:30:25.123
Уровень логирования: DEBUG
======================================================================
```

### Финальное сообщение

```
======================================================================
ФИНАЛ ПРОГРАММЫ - 2024-01-15 14:30:27.456
Итоговое время работы: 2.3330 секунд
======================================================================
```

## Функции генерации JavaScript скриптов

Каждая функция использует индивидуальную конфигурацию из `FUNCTION_CONFIGS` и автоматически загружает данные согласно настройкам.

### 1. generate_leaders_for_admin_script()
- **Назначение**: Информация по загруженным в турнир данным об участниках
- **Домен**: `tournament.example.com`
- **Источник данных**: CSV файл с разделителем `;`
- **Файл**: `leaders_for_admin_data.csv`
- **Столбец**: `participant_id`
- **API**: `/api/tournament/leaders`

### 2. generate_reward_script()
- **Назначение**: Информация о сотрудниках которые уже получили награды
- **Домен**: `rewards.example.com`
- **Источник данных**: CSV файл с разделителем `;`
- **Файл**: `reward_data.csv`
- **Столбец**: `employee_id`
- **API**: `/api/rewards/list`

### 3. generate_profile_script()
- **Назначение**: Профили сотрудников в героях продаж
- **Домен**: `profiles.example.com`
- **Источник данных**: TXT файл с различными разделителями
- **Файл**: `profile_data.txt`
- **API**: `/api/profiles/employee`

### 4. generate_news_details_script()
- **Назначение**: Детальная карточка новости
- **Домен**: `news.example.com`
- **Источник данных**: TXT файл
- **Файл**: `news_details_data.txt`
- **API**: `/api/news/details`

### 5. generate_address_book_tn_script()
- **Назначение**: Карточка сотрудника из адресной книги по табельным номерам
- **Домен**: `directory.example.com`
- **Источник данных**: CSV файл с разделителем `;`
- **Файл**: `address_book_tn_data.csv`
- **Столбец**: `employee_number`
- **API**: `/api/directory/employee`

### 6. generate_address_book_dev_script()
- **Назначение**: Карточка подразделения из адресной книги со списком сотрудников
- **Домен**: `directory.example.com`
- **Источник данных**: CSV файл с разделителем `;`
- **Файл**: `address_book_dev_data.csv`
- **Столбец**: `department_id`
- **API**: `/api/directory/department`

### 7. generate_orders_script()
- **Назначение**: Список сотрудников выбравших преференции
- **Домен**: `orders.example.com`
- **Источник данных**: CSV файл с разделителем `;`
- **Файл**: `orders_data.csv`
- **Столбец**: `employee_id`
- **API**: `/api/orders/preferences`

### 8. generate_news_list_script()
- **Назначение**: Список новостей
- **Домен**: `news.example.com`
- **Источник данных**: Внутренняя переменная (TEST_DATA_LIST)
- **API**: `/api/news/list`

### 9. generate_rating_list_script()
- **Назначение**: Рейтинг участников по полученным наградам и кристаллам
- **Домен**: `rating.example.com`
- **Источник данных**: CSV файл с разделителем `;`
- **Файл**: `rating_list_data.csv`
- **Столбец**: `participant_id`
- **API**: `/api/rating/participants`

### Универсальная функция

- **generate_script_universal(config_key, data_list=None)**: Основная функция генерации, используемая всеми остальными функциями
- Автоматически загружает данные согласно конфигурации
- Поддерживает как файловые, так и переменные источники данных

## Обработка данных

### Источники данных

1. **Внешний файл** (`DATA_SOURCE = "file"`)
   - TXT: Разделение по любым разделителям кроме "_" и "-"
   - CSV: Извлечение данных из указанного столбца

2. **Внутренняя переменная** (`DATA_SOURCE = "variable"`)
   - Использование `TEST_DATA_LIST`

### Объем данных
- Поддерживается от 1 до 100,000 значений
- Типичный объем: 7,000-9,000 значений

## Глобальные переменные

- **logger**: Объект логгера
- **program_start_time**: Время старта программы
- **function_execution_times**: Словарь времен выполнения функций
- **processed_actions_count**: Счетчик обработанных действий

## Декораторы

### @measure_time
Автоматически измеряет время выполнения функций и записывает результаты в лог.

## Функции поддержки

### setup_logging()
Настройка системы логирования с автоматическим созданием директорий (LOGS, INPUT, OUTPUT) и файлов.

### load_data_from_file()
Загрузка данных из файла в зависимости от формата (TXT/CSV).

### get_data()
Получение данных согласно настройкам (файл или переменная).

### copy_to_clipboard()
Копирование сгенерированного скрипта в буфер обмена.

### print_summary()
Вывод итоговой статистики работы программы с временными показателями.

## Настройка окружения

### Автоматическая настройка (рекомендуется)
```bash
./setup_environment.sh
```

### Ручная настройка

#### Создание окружения conda
```bash
# Из файла environment.yml
conda env create -f environment.yml

# Или создание с нуля
conda create -n game_script_env python=3.9 -y
```

#### Активация окружения
```bash
conda activate game_script_env
```

#### Установка зависимостей
```bash
pip install -r requirements.txt
```

## Использование программы

### Запуск
```bash
# Убедитесь что окружение активировано
conda activate game_script_env

# Запуск программы
python main.py
```

### Настройка активных скриптов

Настройте переменную `ACTIVE_SCRIPTS` для выбора нужных скриптов:

```python
ACTIVE_SCRIPTS = [
    "leaders_for_admin",    # CSV с разделителем ;
    "reward",              # CSV с разделителем ;
    "profile",             # TXT с различными разделителями
    "news_list"            # использует переменную согласно конфигурации
]
```

### Альтернативный способ - ручной вызов

```python
# В функции main() раскомментируйте нужные функции:
generate_leaders_for_admin_script()  # CSV с разделителем ;
generate_profile_script()  # TXT с различными разделителями
generate_news_list_script()  # использует переменную согласно конфигурации

# Или передать данные вручную
generate_reward_script(custom_data_list)
```

### Примеры файлов данных

#### CSV файл (leaders_for_admin_data.csv):
```csv
participant_id;name;score;level
12345;Иванов И.И.;850;5
23456;Петров П.П.;720;4
34567;Сидоров С.С.;690;3
```

#### TXT файл (profile_data.txt):
```txt
profile_001,profile_002;profile_003 profile_004	profile_005
profile_006|profile_007:profile_008.profile_009!profile_010
profile_011@profile_012#profile_013$profile_014%profile_015
```

### Результат работы
1. **Консольный вывод**: Сгенерированный JavaScript скрипт
2. **Буфер обмена**: Автоматическое копирование скрипта
3. **Лог файлы**: Подробная информация о выполнении

## Файлы окружения

### requirements.txt
Содержит Python зависимости:
- `pyperclip==1.8.2` - для работы с буфером обмена

### environment.yml
Файл для создания conda окружения со всеми необходимыми зависимостями.

### setup_environment.sh
Автоматический скрипт для настройки окружения. Выполняет:
- Проверку наличия conda
- Создание окружения из environment.yml
- Активацию окружения
- Вывод инструкций по использованию

## Системные требования

- Python 3.9+
- Anaconda или Miniconda

### Зависимости

- **pyperclip==1.8.2** - для работы с буфером обмена
- **pandas==2.0.3** - для работы с данными и Excel
- **openpyxl==3.1.2** - для создания Excel файлов

## JSON Парсеры (Обработка полученных данных)

Отдельные программы для обработки JSON ответов и конвертации их в Excel файлы.

### Базовый класс: JSONToExcelProcessor

- **Файл**: `json_to_excel_base.py`
- **Функции**: Загрузка JSON, разворачивание вложенных структур, фильтрация полей, сохранение в Excel
- **Логирование**: Собственная система логов с временными метками
- **Автоматизация**: Создание директорий, обработка ошибок

### Индивидуальные парсеры

Каждый тип данных имеет свой парсер:

| Парсер | Файл | Входной JSON | Выходной Excel |
|--------|------|--------------|----------------|
| **LeadersForAdmin** | `json_parser_leaders_for_admin.py` | `leaders_for_admin_response.json` | `leaders_for_admin_data.xlsx` |
| **Reward** | `json_parser_reward.py` | `reward_response.json` | `reward_data.xlsx` |
| **Profile** | `json_parser_profile.py` | `profile_response.json` | `profile_data.xlsx` |

### Универсальный запускатель

- **Файл**: `json_parsers_runner.py`
- **Использование**:
  ```bash
  # Запуск одного парсера
  python json_parsers_runner.py leaders_for_admin
  
  # Запуск всех парсеров
  python json_parsers_runner.py all
  ```

### Фильтрация полей

Каждый парсер поддерживает:
- **include_fields**: Список полей для включения
- **exclude_fields**: Список полей для исключения
- **Разворачивание**: Автоматическое преобразование вложенных JSON объектов в плоские колонки
- **Настройка листов**: Индивидуальные названия листов Excel

### Конфигурация полей

```python
"leaders_for_admin": {
    "sheet_name": "Leaders",
    "include_fields": ["id", "name", "score", "level", "rank"],
    "exclude_fields": ["internal_data", "debug_info"]
}
```

## Полный рабочий процесс

### 1. Генерация JavaScript скриптов

```bash
# Настройте ACTIVE_SCRIPTS в main.py
ACTIVE_SCRIPTS = ["leaders_for_admin", "reward"]

# Запустите генерацию
python main.py
```

### 2. Получение JSON данных

Выполните сгенерированные скрипты в браузере (DevTools Console) для получения JSON ответов.

### 3. Обработка JSON в Excel

```bash
# Разместите JSON файлы в INPUT/ папке
# Запустите парсеры:

# Один парсер
python json_parsers_runner.py leaders_for_admin

# Все парсеры
python json_parsers_runner.py all
```

### 4. Результат

Excel файлы с обработанными данными появятся в папке OUTPUT/.

## Структура SUMMARY

В конце выполнения программа выводит статистику:
- Общее время выполнения
- Количество обработанных действий  
- Время выполнения каждой функции
- Дата и время завершения

Пример:
```
======================================================================
SUMMARY - ИТОГОВАЯ СТАТИСТИКА РАБОТЫ ПРОГРАММЫ
======================================================================
Общее время выполнения: 0.0097 секунд
Обработано действий: 5
Выполнено функций: 4

Время выполнения функций:
  - load_data_from_file: 0.0002 сек
  - generate_script_universal: 0.0091 сек
  - copy_to_clipboard: 0.0088 сек

Программа завершена: 2025-07-26 16:45:58.710
======================================================================
```

## Планируемые дополнения

1. **Расширение парсеров**: Создание парсеров для всех 9 типов скриптов
2. **Дополнительные форматы**: Поддержка других форматов входных данных
3. **Автоматизация**: Полная автоматизация процесса от генерации до Excel 